name: Train & Dockerize (MLflow Project)

on:
  push:
    paths:
      - "MLProject/**"
      - ".github/workflows/ci.yml"
  workflow_dispatch:

jobs:
  train_and_docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check Env
        run: |
          python --version
          pip --version
          docker --version || echo "Docker pre-installed on ubuntu-latest"
          echo "Runner: $RUNNER_OS | $(uname -a)"

      - name: Install MLflow & deps
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.19.0 numpy pandas scikit-learn joblib matplotlib

      - name: Run MLflow Project
        working-directory: MLProject
        run: |
          mlflow run . -e main --env-manager local

      - name: Get latest MLflow run_id & model path
        id: fetchrun
        working-directory: MLProject
        shell: bash
        run: |
          set -euo pipefail
          # Ambil direktori run terbaru berdasar mtime (format: mlruns/<exp_id>/<run_id>)
          RUN_DIR=$(ls -td mlruns/*/* 2>/dev/null | head -n1 || true)
          if [[ -z "${RUN_DIR}" ]]; then
            echo "Tidak menemukan RUN_DIR di mlruns/*/*"; exit 1
          fi
          RUN_ID=$(basename "$RUN_DIR")
          MODEL_DIR="$RUN_DIR/artifacts/model"
          if [[ ! -f "${MODEL_DIR}/MLmodel" ]]; then
            echo "Model MLflow tidak ditemukan di ${MODEL_DIR}"; ls -R "$RUN_DIR"; exit 1
          fi
          echo "RUN_DIR=${RUN_DIR}"
          echo "RUN_ID=${RUN_ID}"
          echo "MODEL_DIR=${MODEL_DIR}"
          echo "run_id=${RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "model_dir=${MODEL_DIR}" >> "$GITHUB_OUTPUT"


      - name: Upload MLruns artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: mlruns_artifacts
          path: MLProject/mlruns/**

      - name: Generate Dockerfile from MLflow model
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        id: gendock
        working-directory: MLProject
        run: |
          set -e
          OUT_DIR="mlflow-dockerfile"
          rm -rf "$OUT_DIR"
          mlflow models generate-dockerfile -m "${{ steps.fetchrun.outputs.model_dir }}"
          test -f "$OUT_DIR/Dockerfile" || { echo "Dockerfile tidak ditemukan di $OUT_DIR"; ls -la "$OUT_DIR"; exit 1; }
          echo "out_dir=$OUT_DIR" >> "$GITHUB_OUTPUT"

      - name: Check DockerHub secrets
        run: |
          test -n "${{ secrets.DOCKERHUB_USERNAME }}" || (echo "Missing DOCKERHUB_USERNAME" && exit 1)
          test -n "${{ secrets.DOCKERHUB_PASSWORD }}" || (echo "Missing DOCKERHUB_PASSWORD" && exit 1)

      - name: Login to Docker Hub
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Docker image
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        uses: docker/build-push-action@v6
        with:
          context: MLProject/${{ steps.gendock.outputs.out_dir }}
          file: MLProject/${{ steps.gendock.outputs.out_dir }}/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/adult_income:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/adult_income:${{ steps.fetchrun.outputs.run_id }}


      - name: Tag Docker image (run_id)
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        env:
          IMAGE_BASE: ${{ secrets.DOCKERHUB_USERNAME }}/adult_income
        run: |
          docker tag "$IMAGE_BASE:latest" "$IMAGE_BASE:${{ steps.fetchrun.outputs.run_id }}"

      - name: Push Docker images
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        env:
          IMAGE_BASE: ${{ secrets.DOCKERHUB_USERNAME }}/adult_income
        run: |
          docker push "$IMAGE_BASE:latest"
          docker push "$IMAGE_BASE:${{ steps.fetchrun.outputs.run_id }}"

      - name: Publish image info
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        run: |
          echo "Pushed: ${{ secrets.DOCKERHUB_USERNAME }}/adult_income:latest"
          echo "Pushed: ${{ secrets.DOCKERHUB_USERNAME }}/adult_income:${{ steps.fetchrun.outputs.run_id }}"
