name: Train & Dockerize (MLflow Project)

on:
  push:
    paths:
      - "MLProject/**"
      - ".github/workflows/ci.yml"
  workflow_dispatch:

jobs:
  train_and_docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check Env
        run: |
          python --version
          pip --version
          docker --version || echo "Docker pre-installed on ubuntu-latest"
          echo "Runner: $RUNNER_OS | $(uname -a)"

      - name: Install MLflow & deps
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.19.0 numpy pandas scikit-learn joblib matplotlib

      - name: Run MLflow Project
        working-directory: MLProject
        run: |
          mlflow run . -e main --env-manager local

      - name: Get latest MLflow run_id & model path
        id: fetchrun
        working-directory: MLProject
        shell: bash
        run: |
          set -e
          # ambil direktori run terbaru (yang punya meta.yaml)
          RUN_DIR=$(find mlruns -type f -name "meta.yaml" -path "*/mlruns/*/*/meta.yaml" \
                    | xargs -r dirname | sort | tail -n1)
          RUN_ID=$(basename "$RUN_DIR")
          MODEL_DIR="$RUN_DIR/artifacts/model"
          echo "RUN_DIR=$RUN_DIR"
          echo "RUN_ID=$RUN_ID"
          echo "MODEL_DIR=$MODEL_DIR"
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
          echo "model_dir=$MODEL_DIR" >> "$GITHUB_OUTPUT"

      - name: Upload MLruns artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: mlruns_artifacts
          path: MLProject/mlruns/**

      - name: Generate Dockerfile from MLflow model
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        working-directory: MLProject
        run: |
          mlflow models generate-dockerfile -m "${{ steps.fetchrun.outputs.model_dir }}" -n adult-income

      - name: Docker login
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build Docker image (latest)
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        working-directory: MLProject
        env:
          IMAGE_BASE: ${{ secrets.DOCKERHUB_USERNAME }}/adult_income
        run: |
          docker build -t "$IMAGE_BASE:latest" .

      - name: Tag Docker image (run_id)
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        env:
          IMAGE_BASE: ${{ secrets.DOCKERHUB_USERNAME }}/adult_income
        run: |
          docker tag "$IMAGE_BASE:latest" "$IMAGE_BASE:${{ steps.fetchrun.outputs.run_id }}"

      - name: Push Docker images
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        env:
          IMAGE_BASE: ${{ secrets.DOCKERHUB_USERNAME }}/adult_income
        run: |
          docker push "$IMAGE_BASE:latest"
          docker push "$IMAGE_BASE:${{ steps.fetchrun.outputs.run_id }}"

      - name: Publish image info
        if: ${{ steps.fetchrun.outputs.model_dir != '' }}
        run: |
          echo "Pushed: ${{ secrets.DOCKERHUB_USERNAME }}/adult_income:latest"
          echo "Pushed: ${{ secrets.DOCKERHUB_USERNAME }}/adult_income:${{ steps.fetchrun.outputs.run_id }}"
